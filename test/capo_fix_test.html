<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capoä¿®æ­£åŠŸèƒ½æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-case {
            border: 1px solid #ddd;
            margin: 15px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .test-case.pass {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .test-case.fail {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .test-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .expected, .actual {
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            margin: 5px 0;
        }
        .expected {
            border-left: 4px solid #28a745;
        }
        .actual {
            border-left: 4px solid #007bff;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 3px;
            margin: 5px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .summary {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .summary.pass {
            background: #d4edda;
            color: #155724;
        }
        .summary.fail {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>ğŸ¸ Capoä¿®æ­£åŠŸèƒ½æ¸¬è©¦</h1>
    
    <div class="test-container">
        <button onclick="runAllTests()">åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</button>
        <button onclick="clearResults()">æ¸…é™¤çµæœ</button>
    </div>

    <div id="test-results"></div>
    <div id="summary"></div>

    <script type="module">
        // æ¨¡æ“¬å°å…¥æ‰€éœ€çš„å‡½æ•¸
        import { transposeChord, transposeChordSheet } from '../assets/js/modules/transpose.js';

        // æ¨¡æ“¬ app.js ä¸­çš„æ ¸å¿ƒåŠŸèƒ½
        function simulateCapoChange(originalSheet, currentKey, originalKey, newCapo) {
            try {
                let processedSheet = originalSheet;
                
                // è¨ˆç®—æ–°çš„å‰ä»–å½ˆå¥èª¿æ€§ï¼šç‚ºäº†é”åˆ°ç›®æ¨™èª¿æ€§ï¼Œåœ¨ç•¶å‰capoä½ç½®ä¸‹æ‡‰è©²å½ˆä»€éº¼èª¿
                const newGuitarKey = transposeChord(currentKey, -newCapo);
                
                // æ›´æ–°Keyè¡Œçš„æ ¼å¼ï¼Œä¿æŒç›®æ¨™èª¿æ€§ä¸è®Šï¼Œä½†æ›´æ–°AG(å‰ä»–å½ˆå¥èª¿æ€§)å’ŒCapo
                const keyPattern = /(Key\s*[:ï¼š]\s*)([A-G][b#]?)(\s*\(\s*AG\s*[:ï¼š]\s*)([A-G][b#]?)(\s*\))/gi;
                processedSheet = processedSheet.replace(keyPattern, `$1${currentKey}$3${newGuitarKey}$5`);
                
                // æ›´æ–°å–®ç¨çš„Capoæ¨™è¨˜
                const capoPattern = /(Capo\s*[:ï¼š]\s*)(\d+)/gi;
                processedSheet = processedSheet.replace(capoPattern, `$1${newCapo}`);
                
                // åŸ·è¡Œå’Œå¼¦è½‰èª¿ï¼ˆå¾åŸå§‹å‰ä»–èª¿æ€§è½‰åˆ°æ–°çš„å‰ä»–èª¿æ€§ï¼‰
                const transposedSheet = transposeChordSheet(processedSheet, originalKey, newGuitarKey, 0);
                
                return transposedSheet;
            } catch (error) {
                throw new Error('è½‰èª¿éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
            }
        }

        // æ¸¬è©¦æ¡ˆä¾‹
        const testCases = [
            {
                name: "åŸå§‹æ¡ˆä¾‹ - Capo 3 åˆ° 0",
                originalSheet: `Key: Bb (AG:G)   Capo: 3

[Pre]
    G  |  D  

[Verse 1]
   G          Em`,
                currentKey: "Bb",
                originalKey: "G",
                newCapo: 0,
                expected: {
                    keyLine: "Key: Bb (AG:Bb)   Capo: 0",
                    chords: ["Bb", "F", "Bb", "Gm"]
                }
            },
            {
                name: "Capo 0 åˆ° 3",
                originalSheet: `Key: Bb (AG:Bb)   Capo: 0

[Pre]
    Bb  |  F  

[Verse 1]
   Bb          Gm`,
                currentKey: "Bb",
                originalKey: "Bb",
                newCapo: 3,
                expected: {
                    keyLine: "Key: Bb (AG:G)   Capo: 3",
                    chords: ["G", "D", "G", "Em"]
                }
            },
            {
                name: "ç›®æ¨™èª¿æ€§è®Šæ›´ - Cèª¿",
                originalSheet: `Key: Bb (AG:G)   Capo: 3

[Pre]
    G  |  D  

[Verse 1]
   G          Em`,
                currentKey: "C",
                originalKey: "G",
                newCapo: 3,
                expected: {
                    keyLine: "Key: C (AG:G#)   Capo: 3",
                    chords: ["G#", "D#", "G#", "Fm"]
                }
            },
            {
                name: "Capo 5 æ¸¬è©¦",
                originalSheet: `Key: D (AG:A)   Capo: 7

[Verse]
   A          F#m
   D          E`,
                currentKey: "D",
                originalKey: "A",
                newCapo: 5,
                expected: {
                    keyLine: "Key: D (AG:Bb)   Capo: 5",
                    chords: ["Bb", "Gm", "Eb", "F"]
                }
            },
            {
                name: "è¤‡é›œå’Œå¼¦æ¸¬è©¦",
                originalSheet: `Key: G (AG:D)   Capo: 7

[Chorus]
      Dmaj7  Asus4    G 
      Em7    Bm       A`,
                currentKey: "G",
                originalKey: "D",
                newCapo: 2,
                expected: {
                    keyLine: "Key: G (AG:E)   Capo: 2",
                    chords: ["Emaj7", "Bsus4", "A", "F#m7", "C#m", "B"]
                }
            }
        ];

        // åŸ·è¡Œå–®å€‹æ¸¬è©¦
        function runSingleTest(testCase) {
            try {
                const result = simulateCapoChange(
                    testCase.originalSheet,
                    testCase.currentKey,
                    testCase.originalKey,
                    testCase.newCapo
                );

                // é©—è­‰ Key è¡Œ
                const keyLineMatch = result.match(/(Key\s*[:ï¼š]\s*[A-G][b#]?\s*\(\s*AG\s*[:ï¼š]\s*[A-G][b#]?\s*\)\s*Capo\s*[:ï¼š]\s*\d+)/i);
                const actualKeyLine = keyLineMatch ? keyLineMatch[0] : "æœªæ‰¾åˆ°Keyè¡Œ";

                // æå–æ‰€æœ‰å’Œå¼¦
                const chordMatches = result.match(/\b([A-G][b#]?(?:maj|min|m|dim|aug|sus|add|dom|alt)?(?:\d+)?(?:[b#]\d+)?)\b/g);
                const actualChords = chordMatches ? chordMatches.filter(chord => 
                    !chord.match(/^(Key|AG|Capo|Pre|Verse|Chorus|Tag|Bridge)$/i)
                ) : [];

                // æª¢æŸ¥çµæœ
                const keyLinePass = actualKeyLine === testCase.expected.keyLine;
                const chordsPass = JSON.stringify(actualChords) === JSON.stringify(testCase.expected.chords);
                const testPass = keyLinePass && chordsPass;

                return {
                    pass: testPass,
                    actualKeyLine,
                    actualChords,
                    keyLinePass,
                    chordsPass,
                    fullResult: result
                };
            } catch (error) {
                return {
                    pass: false,
                    error: error.message
                };
            }
        }

        // é¡¯ç¤ºæ¸¬è©¦çµæœ
        function displayTestResult(testCase, result, index) {
            const container = document.getElementById('test-results');
            const testDiv = document.createElement('div');
            testDiv.className = `test-case ${result.pass ? 'pass' : 'fail'}`;
            
            let html = `
                <div class="test-title">æ¸¬è©¦ ${index + 1}: ${testCase.name}</div>
            `;

            if (result.error) {
                html += `<div class="error">éŒ¯èª¤: ${result.error}</div>`;
            } else {
                html += `
                    <div>
                        <strong>Keyè¡Œæ¸¬è©¦:</strong> ${result.keyLinePass ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}
                        <div class="expected">æœŸæœ›: ${testCase.expected.keyLine}</div>
                        <div class="actual">å¯¦éš›: ${result.actualKeyLine}</div>
                    </div>
                    <div>
                        <strong>å’Œå¼¦æ¸¬è©¦:</strong> ${result.chordsPass ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}
                        <div class="expected">æœŸæœ›å’Œå¼¦: [${testCase.expected.chords.join(', ')}]</div>
                        <div class="actual">å¯¦éš›å’Œå¼¦: [${result.actualChords.join(', ')}]</div>
                    </div>
                    <details>
                        <summary>å®Œæ•´è¼¸å‡º</summary>
                        <pre>${result.fullResult}</pre>
                    </details>
                `;
            }

            testDiv.innerHTML = html;
            container.appendChild(testDiv);
        }

        // åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
        window.runAllTests = function() {
            const container = document.getElementById('test-results');
            container.innerHTML = '';
            
            let passCount = 0;
            let totalCount = testCases.length;

            testCases.forEach((testCase, index) => {
                const result = runSingleTest(testCase);
                displayTestResult(testCase, result, index);
                if (result.pass) passCount++;
            });

            // é¡¯ç¤ºæ‘˜è¦
            const summaryDiv = document.getElementById('summary');
            summaryDiv.className = `summary ${passCount === totalCount ? 'pass' : 'fail'}`;
            summaryDiv.innerHTML = `
                æ¸¬è©¦æ‘˜è¦: ${passCount}/${totalCount} é€šé
                ${passCount === totalCount ? 'ğŸ‰ æ‰€æœ‰æ¸¬è©¦éƒ½é€šéäº†ï¼' : 'âš ï¸ æœ‰æ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸Šè¿°çµæœ'}
            `;
        };

        // æ¸…é™¤çµæœ
        window.clearResults = function() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('summary').innerHTML = '';
        };

        // é é¢è¼‰å…¥å¾Œè‡ªå‹•åŸ·è¡Œæ¸¬è©¦
        window.addEventListener('load', () => {
            console.log('æ¸¬è©¦é é¢å·²è¼‰å…¥ï¼Œé»æ“ŠæŒ‰éˆ•é–‹å§‹æ¸¬è©¦');
        });
    </script>
</body>
</html>
