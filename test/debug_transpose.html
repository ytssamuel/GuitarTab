<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ è½‰èª¿èª¿è©¦å·¥å…·</title>
    <style>
        body { 
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif; 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto;
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .debug-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #e9ecef; 
            border-radius: 8px; 
            background: #f8f9fa;
        }
        .test-input { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            border: 1px solid #ced4da; 
            border-radius: 6px;
            font-family: 'Monaco', 'Fira Code', monospace;
            font-size: 14px;
        }
        .test-output { 
            padding: 15px; 
            background: #e3f2fd; 
            border-left: 4px solid #2196f3; 
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: 'Monaco', 'Fira Code', monospace;
            font-size: 14px;
        }
        .error-output {
            background: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }
        .success-output {
            background: #e8f5e8;
            border-left-color: #4caf50;
            color: #2e7d32;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .chord-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px;
            margin: 15px 0;
        }
        .chord-item {
            padding: 8px;
            text-align: center;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-family: 'Monaco', 'Fira Code', monospace;
            font-weight: bold;
        }
        .before { background: #fff3cd; }
        .after { background: #d1ecf1; }
        h1 { color: #495057; margin-bottom: 30px; }
        h2 { color: #6c757d; margin-top: 30px; margin-bottom: 15px; }
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        label {
            font-weight: 600;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ è½‰èª¿èª¿è©¦å·¥å…·</h1>
        <p>ç”¨æ–¼æ¸¬è©¦å’Œèª¿è©¦å’Œå¼¦è½‰èª¿åŠŸèƒ½çš„å°ˆç”¨å·¥å…·</p>

        <div class="controls">
            <label for="fromKey">åŸèª¿:</label>
            <select id="fromKey">
                <option value="C">C</option>
                <option value="C#">C#</option>
                <option value="D">D</option>
                <option value="Eb">Eb</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F#</option>
                <option value="G" selected>G</option>
                <option value="G#">G#</option>
                <option value="A">A</option>
                <option value="Bb">Bb</option>
                <option value="B">B</option>
            </select>

            <label for="toKey">ç›®æ¨™èª¿:</label>
            <select id="toKey">
                <option value="C">C</option>
                <option value="C#">C#</option>
                <option value="D" selected>D</option>
                <option value="Eb">Eb</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F#</option>
                <option value="G">G</option>
                <option value="G#">G#</option>
                <option value="A">A</option>
                <option value="Bb">Bb</option>
                <option value="B">B</option>
            </select>

            <label for="capo">Capo:</label>
            <select id="capo">
                <option value="0" selected>0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
            </select>

            <button onclick="runLiveTest()">ğŸ§ª å³æ™‚æ¸¬è©¦</button>
            <button onclick="runBugTests()">ğŸ› Bugæ¸¬è©¦</button>
            <button onclick="runComplexTests()">ğŸ¼ è¤‡é›œå’Œå¼¦æ¸¬è©¦</button>
        </div>

        <div class="debug-section">
            <h2>ğŸ“ è¼¸å…¥æ¨‚è­œ</h2>
            <textarea id="inputSheet" class="test-input" rows="10" placeholder="è«‹è¼¸å…¥åŒ…å«å’Œå¼¦çš„Markdownæ¨‚è­œ...">### [å‰ä»–è­œ] æ¸¬è©¦æ­Œæ›²

Key: G   Capo: 0

[Verse]
G          Em7
æ¸¬è©¦æ­Œè©ä¸€è¡Œ
      Cmaj7    D7   G       
æ¸¬è©¦æ­Œè©ç¬¬äºŒè¡Œ
   Bm7        Em7
æ¸¬è©¦è¤‡é›œå’Œå¼¦
        Am7      D7    G
æœ€å¾Œä¸€è¡Œæ¸¬è©¦</textarea>
        </div>

        <div class="debug-section">
            <h2>ğŸ“¤ è½‰èª¿çµæœ</h2>
            <div id="output" class="test-output">é»æ“Š"å³æ™‚æ¸¬è©¦"æŸ¥çœ‹çµæœ...</div>
        </div>

        <div class="debug-section">
            <h2>ğŸ” å’Œå¼¦å°ç…§è¡¨</h2>
            <div id="chordComparison"></div>
        </div>

        <div class="debug-section">
            <h2>ğŸ§ª è‡ªå‹•åŒ–æ¸¬è©¦çµæœ</h2>
            <div id="testResults"></div>
        </div>
    </div>

    <script type="module">
        import { transposeChordSheet, transposeChord, isValidChord, isValidKey } from '../assets/js/modules/transpose.js';

        window.runLiveTest = function() {
            const fromKey = document.getElementById('fromKey').value;
            const toKey = document.getElementById('toKey').value;
            const capo = parseInt(document.getElementById('capo').value);
            const inputSheet = document.getElementById('inputSheet').value;
            const outputDiv = document.getElementById('output');

            try {
                const result = transposeChordSheet(inputSheet, fromKey, toKey, capo);
                outputDiv.className = 'test-output success-output';
                outputDiv.textContent = result;
                
                // æ›´æ–°å’Œå¼¦å°ç…§è¡¨
                updateChordComparison(inputSheet, result);
                
            } catch (error) {
                outputDiv.className = 'test-output error-output';
                outputDiv.textContent = `éŒ¯èª¤: ${error.message}`;
            }
        };

        function updateChordComparison(originalSheet, transposedSheet) {
            const originalChords = extractChords(originalSheet);
            const transposedChords = extractChords(transposedSheet);
            
            const comparisonDiv = document.getElementById('chordComparison');
            
            if (originalChords.length === 0) {
                comparisonDiv.innerHTML = '<p>æœªç™¼ç¾å’Œå¼¦</p>';
                return;
            }

            let html = '<div class="chord-grid">';
            
            const maxLength = Math.max(originalChords.length, transposedChords.length);
            for (let i = 0; i < maxLength; i++) {
                const orig = originalChords[i] || '';
                const trans = transposedChords[i] || '';
                
                html += `
                    <div class="chord-item before">${orig}</div>
                    <div class="chord-item after">${trans}</div>
                `;
            }
            
            html += '</div>';
            html += '<p><strong>èªªæ˜:</strong> é»ƒè‰²=åŸå§‹å’Œå¼¦ï¼Œè—è‰²=è½‰èª¿å¾Œå’Œå¼¦</p>';
            
            comparisonDiv.innerHTML = html;
        }

        function extractChords(sheet) {
            const chordRegex = /\b([A-G][b#]?(?:(?:maj|min|m|dim|aug|sus|add|dom|alt)?(?:\d+)?(?:\/[A-G][b#]?)?)?)\b/g;
            const matches = [];
            let match;
            
            while ((match = chordRegex.exec(sheet)) !== null) {
                if (isValidChord(match[1].split(/[^A-G#b]/)[0])) {
                    matches.push(match[1]);
                }
            }
            
            return [...new Set(matches)]; // å»é‡
        }

        window.runBugTests = function() {
            const testCases = [
                {
                    name: "ä¿®æ­£ #b å•é¡Œ",
                    input: "C D E F G A B",
                    fromKey: "C",
                    toKey: "Db",
                    capo: 0,
                    expectedFixed: true,
                    description: "è½‰èª¿å¾Œä¸æ‡‰å‡ºç¾å¦‚C#bçš„æƒ…æ³"
                },
                {
                    name: "è¤‡é›œå’Œå¼¦è­˜åˆ¥ - Bm7",
                    input: "Bm7 Cmaj7 Dsus4",
                    fromKey: "C", 
                    toKey: "D",
                    capo: 0,
                    expected: "C#m7 Dmaj7 Esus4",
                    description: "è¤‡é›œå’Œå¼¦å¦‚Bm7æ‡‰è©²è¢«æ­£ç¢ºè­˜åˆ¥å’Œè½‰æ›"
                },
                {
                    name: "æ–œç·šå’Œå¼¦æ¸¬è©¦",
                    input: "C/E Am/C D/F#",
                    fromKey: "C",
                    toKey: "G", 
                    capo: 0,
                    expected: "G/B Em/G A/C#",
                    description: "æ–œç·šå’Œå¼¦æ‡‰è©²è¢«æ­£ç¢ºè™•ç†"
                }
            ];

            runTestSuite(testCases);
        };

        window.runComplexTests = function() {
            const testCases = [
                {
                    name: "æ‰€æœ‰è¤‡é›œå’Œå¼¦é¡å‹",
                    input: "Cmaj7 Dm7 Em7 Fmaj7 G7 Am7 Bm7b5",
                    fromKey: "C",
                    toKey: "G",
                    capo: 0,
                    expected: "Gmaj7 Am7 Bm7 Cmaj7 D7 Em7 F#m7b5"
                },
                {
                    name: "addå’Œå¼¦å’Œsuså’Œå¼¦",
                    input: "Cadd9 Dsus2 Gsus4 Aadd11",
                    fromKey: "C",
                    toKey: "F",
                    capo: 0,
                    expected: "Fadd9 Gsus2 Csus4 Dadd11"
                },
                {
                    name: "æ¸›å’Œå¼¦èˆ‡å¢å’Œå¼¦",
                    input: "Cdim Daug Gdim7 Aaug",
                    fromKey: "C", 
                    toKey: "E",
                    capo: 0,
                    expected: "Edim F#aug Bdim7 C#aug"
                }
            ];

            runTestSuite(testCases);
        };

        function runTestSuite(testCases) {
            const resultsDiv = document.getElementById('testResults');
            let html = '';
            let passCount = 0;

            testCases.forEach((testCase, index) => {
                try {
                    const result = transposeChordSheet(
                        testCase.input,
                        testCase.fromKey,
                        testCase.toKey,
                        testCase.capo
                    );

                    let passed = false;
                    let status = '';

                    if (testCase.expected) {
                        passed = result.trim() === testCase.expected.trim();
                        status = passed ? 'âœ… é€šé' : 'âŒ å¤±æ•—';
                    } else if (testCase.expectedFixed) {
                        // æª¢æŸ¥æ˜¯å¦åŒ…å«#bæ¨¡å¼
                        const hasInvalidEnharmonic = /[A-G]#b|[A-G]b#/.test(result);
                        passed = !hasInvalidEnharmonic;
                        status = passed ? 'âœ… å·²ä¿®æ­£' : 'âŒ ä»æœ‰å•é¡Œ';
                    }

                    if (passed) passCount++;

                    html += `
                        <div style="margin: 15px 0; padding: 15px; border: 1px solid ${passed ? '#28a745' : '#dc3545'}; border-radius: 6px; background: ${passed ? '#f8fff8' : '#fff8f8'};">
                            <h4>${testCase.name} ${status}</h4>
                            <p><strong>æè¿°:</strong> ${testCase.description || 'ç„¡'}</p>
                            <p><strong>è¼¸å…¥:</strong> ${testCase.input}</p>
                            <p><strong>è½‰èª¿:</strong> ${testCase.fromKey} â†’ ${testCase.toKey} (Capo: ${testCase.capo})</p>
                            <p><strong>çµæœ:</strong> ${result}</p>
                            ${testCase.expected ? `<p><strong>é æœŸ:</strong> ${testCase.expected}</p>` : ''}
                        </div>
                    `;
                } catch (error) {
                    html += `
                        <div style="margin: 15px 0; padding: 15px; border: 1px solid #dc3545; border-radius: 6px; background: #fff8f8;">
                            <h4>${testCase.name} âŒ éŒ¯èª¤</h4>
                            <p><strong>éŒ¯èª¤:</strong> ${error.message}</p>
                        </div>
                    `;
                }
            });

            html = `<h3>æ¸¬è©¦çµæœ: ${passCount}/${testCases.length} é€šé</h3>` + html;
            resultsDiv.innerHTML = html;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”§ è½‰èª¿èª¿è©¦å·¥å…·å·²è¼‰å…¥');
            runLiveTest(); // è‡ªå‹•åŸ·è¡Œä¸€æ¬¡æ¸¬è©¦
        });
    </script>
</body>
</html>
