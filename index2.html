<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å’Œå¼¦è­œè½‰èª¿å·¥å…·</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f9f9f9; }
    pre { background: #fff; padding: 1em; border: 1px solid #ccc; white-space: pre-wrap; }
    .controls { margin-bottom: 1em; }
    button, input[type="file"] { margin: 4px; padding: 6px 12px; }
    h2 { margin-top: 1em; }
  </style>
</head>
<body>

<h1>ğŸ¸ å’Œå¼¦è­œè½‰èª¿å·¥å…·</h1>

<div class="controls">
  <h2>ğŸ¼ é¸æ“‡èª¿æ€§ (Key):</h2>
  <div id="key-buttons"></div>

  <h2>ğŸ¸ Capo ä½ç½®:</h2>
  <div id="capo-buttons"></div>

  <h2>ğŸ“¤ ä¸Šå‚³æ­Œè­œæª” (.txt/.md)ï¼š</h2>
  <input type="file" id="file-input" accept=".txt,.md" />

  <h2>ğŸ“¥ ä¸‹è¼‰ç›®å‰æ­Œè­œï¼š</h2>
  <button onclick="downloadChordSheet()">ä¸‹è¼‰</button>
</div>

<h2>å’Œå¼¦è­œ:</h2>
<pre id="chord-display"></pre>

<script>
const keys = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const chordMap = {
  'C':0,'C#':1,'Db':1,'D':2,'D#':3,'Eb':3,'E':4,'F':5,'F#':6,'Gb':6,'G':7,'G#':8,'Ab':8,'A':9,'A#':10,'Bb':10,'B':11
};

let originalKey = 'G';
let currentKey = 'G';
let capo = 0;
let chordSheet = '';

function transposeChord(chord, diff) {
  let match = chord.match(/^([A-G][b#]?)(.*)$/);
  if (!match) return chord;
  let [_, root, suffix] = match;
  let idx = (chordMap[root] + diff + 12) % 12;
  return keys[idx] + suffix;
}

function transposeChordSheet(sheet, fromKey, toKey, capoShift) {
  let diff = (chordMap[toKey] - chordMap[fromKey] - capoShift + 12) % 12;
  return sheet.replace(/\b([A-G][b#]?)(maj7|sus4|m|min|dim|aug|add\d*|\d*|)?\b/g, (m, root, suffix) => {
    return transposeChord(root + (suffix || ''), diff);
  });
}

function renderChordSheet() {
  const updated = transposeChordSheet(chordSheet, originalKey, currentKey, capo);
  document.getElementById("chord-display").textContent = updated;
}

function createButtons(containerId, values, clickHandler) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  values.forEach(val => {
    const btn = document.createElement("button");
    btn.textContent = val;
    btn.onclick = () => {
      clickHandler(val);
      renderChordSheet();
    };
    container.appendChild(btn);
  });
}

// åˆå§‹åŒ– Key èˆ‡ Capo é¸å–®
createButtons("key-buttons", keys, key => currentKey = key);
createButtons("capo-buttons", Array.from({length: 9}, (_, i) => i), c => capo = parseInt(c));

// è™•ç†ä¸Šå‚³
document.getElementById("file-input").addEventListener("change", event => {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const text = e.target.result;
    chordSheet = text;

    // è‡ªå‹•æŠ“ Key èˆ‡ Capoï¼ˆæ ¼å¼ï¼šKey : G   Capo : 3ï¼‰
    const keyMatch = text.match(/Key\s*[:ï¼š]\s*([A-G][b#]?)/);
    const capoMatch = text.match(/Capo\s*[:ï¼š]\s*(\d+)/);
    if (keyMatch) {
      originalKey = currentKey = keyMatch[1];
    }
    if (capoMatch) {
      capo = parseInt(capoMatch[1]);
    }

    // é‡å»ºæŒ‰éˆ•ï¼ˆæ›´æ–°é¸å–ç‹€æ…‹ï¼‰
    createButtons("key-buttons", keys, key => currentKey = key);
    createButtons("capo-buttons", Array.from({length: 9}, (_, i) => i), c => capo = parseInt(c));
    renderChordSheet();
  };
  reader.readAsText(file);
});

// ä¸‹è¼‰åŠŸèƒ½
function downloadChordSheet() {
  const converted = transposeChordSheet(chordSheet, originalKey, currentKey, capo);
  const blob = new Blob([converted], {type: "text/plain"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "è½‰èª¿æ­Œè­œ.txt";
  link.click();
}
</script>

</body>
</html>
